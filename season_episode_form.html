<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <style>
        :root {
            --bg-color: #0d0d0d; 
            --card-color: #1a1a1a; 
            --text-color: #f5f5f5; 
            --accent-color: #e50914; 
            --primary-color: #007bff;
        }
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top, #141414, #000);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
        }
        .container {
            background-color: var(--card-color);
            padding: 30px; border-radius: 12px; max-width: 700px; margin: 20px auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        h1 { color: var(--accent-color); margin-bottom: 20px; text-align: center; }
        h2 { color: var(--text-color); font-size: 1.2em; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        input[type="text"], input[type="number"], textarea { 
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #333;
            background-color: #333; color: var(--text-color); font-size: 16px; box-sizing: border-box; resize: vertical;
        }
        button {
            width: 100%; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 5px;
            background-color: var(--primary-color); color: white; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        .back-btn { display: block; margin-bottom: 20px; text-align: right; color: var(--primary-color); text-decoration: none; }
        #message { color: var(--accent-color); text-align: center; margin-top: 10px; font-weight: bold; }
        
        input:disabled { background-color: #111; color: #aaa; cursor: not-allowed; }
    </style>
</head>
<body>

    <a id="back-link" href="series_list.html" class="back-btn">&larr; Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø³Ù…</a>
    
    <div class="container">
        <h1 id="form-title">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
        <p id="series-info" style="text-align: center; color: #aaa;"></p>

        <form id="episode-form">
            <h2>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
            <input type="number" id="episodeNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© (Ù…Ø«Ø§Ù„: 1, 10)" required min="1">
            <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù„Ù‚Ø© (Ù…Ø«Ø§Ù„: Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…)" required>
            <textarea id="description" placeholder="ÙˆØµÙ Ù…ÙˆØ¬Ø² Ù„Ù„Ø­Ù„Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3"></textarea>

            <h2 style="margin-top: 30px;">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´ØºÙ„ (Embed)</h2>
            <input type="text" id="bunnystream" placeholder="1. BunnyStream Link (Ø§Ø­ØªØ±Ø§ÙÙŠ/Ù†Ø¸ÙŠÙ)">
            <input type="text" id="dood" placeholder="2. UQLOAD Link (Ù…Ø¬Ø§Ù†ÙŠ/Ø¥Ø¹Ù„Ø§Ù†Ø§Øª)">

            <div id="message"></div>
            
            <button type="submit" id="submit-btn">Ø­ÙØ¸ Ø§Ù„Ø­Ù„Ù‚Ø©</button>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // ===============================================
        //  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙˆØ§Ù„Ù€ UID
        // ===============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBApoSZ-HXy9kd07tSJfuRdWkJcrbQVYf0", 
            authDomain: "qmove1.firebaseapp.com",
            projectId: "qmove1",
            storageBucket: "qmove1.firebasestorage.app",
            messagingSenderId: "166464805371",
            appId: "1:166464805371:web:d65b0cb8b141e4b894935e"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_UID = 'rHIJXeazJiMsgAc1HDRO3vzFFV02'; 

        const form = document.getElementById('episode-form');
        const message = document.getElementById('message');
        const urlParams = new URLSearchParams(window.location.search);
        
        const seriesId = urlParams.get('seriesId');
        const seasonNum = urlParams.get('seasonNum');
        const episodeId = urlParams.get('episodeId'); 

        document.getElementById('back-link').href = `season_episode_manager.html?seriesId=${seriesId}`;


        // ===============================================
        //  Ø¯ÙˆØ¢Ù„ Ø¬Ù„Ø¨ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ===============================================

        // ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ù„Ø³Ù„ ÙˆØ¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        db.collection('series').doc(seriesId).get().then(doc => {
            if (doc.exists) {
                document.getElementById('series-info').textContent = `Ù…Ø³Ù„Ø³Ù„: ${doc.data().title} | Ø§Ù„Ù…ÙˆØ³Ù… ${seasonNum}`;
            }
        });
        
        // ğŸ”¥ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙˆØ±Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit Mode)
        if (episodeId) {
            document.getElementById('form-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø©';
            document.getElementById('submit-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            
            db.collection(`series/${seriesId}/seasons/${seasonNum}/episodes`).doc(episodeId).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // ğŸ”¥ğŸ”¥ğŸ”¥ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù€ episodeNumber ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…ÙŠ Ù‡Ù†Ø§
                        document.getElementById('episodeNumber').value = data.episodeNumber || ''; 
                        
                        document.getElementById('title').value = data.title || '';
                        document.getElementById('description').value = data.description || '';
                        
                        const servers = data.servers || {};
                        document.getElementById('bunnystream').value = servers.bunnystream || '';
                        document.getElementById('dood').value = servers.dood || '';

                        document.getElementById('episodeNumber').disabled = true; 
                    } else {
                        message.textContent = 'Ø§Ù„Ø­Ù„Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.';
                    }
                })
                .catch(error => {
                    message.textContent = `Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø©: ${error.message}`;
                });
        }
        
        // ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            message.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            const episodeNumberInput = document.getElementById('episodeNumber').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;

            const bunnystreamLink = document.getElementById('bunnystream').value.trim();
            const doodLink = document.getElementById('dood').value.trim();
            
            // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø¥Ù„Ù‰ integer Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø²Ù† ğŸ”¥ğŸ”¥ğŸ”¥
            const episodeNumberNumeric = parseInt(episodeNumberInput); 
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­
            if (isNaN(episodeNumberNumeric)) {
                 message.textContent = 'Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­.';
                 message.style.color = 'var(--accent-color)';
                 return;
            }

            const episodeData = {
                episodeNumber: episodeNumberNumeric, // ğŸ”¥ ÙŠØ®Ø²Ù† ÙƒÙ€ Number
                title: title,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                servers: { bunnystream: bunnystreamLink, dood: doodLink }
            };

            const collectionPath = `series/${seriesId}/seasons/${seasonNum}/episodes`;
            let savePromise;

            if (episodeId) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                savePromise = db.collection(collectionPath).doc(episodeId).update(episodeData);
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ù†Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© (Ø§Ù„Ù†Øµ) ÙƒÙ€ ID (Ø­ØªÙ‰ Ù„Ùˆ Ø®Ø±Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØµÙŠØŒ Ø§Ù„Ø£ÙØ¶Ù„ Ù†Ø³ØªØ®Ø¯Ù… ID ÙØ±ÙŠØ¯)
                savePromise = db.collection(collectionPath).doc(episodeNumberInput).set(episodeData);
            }

            savePromise.then(() => {
                message.textContent = episodeId ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!';
                message.style.color = 'lightgreen';
                
                setTimeout(() => {
                     window.location.href = `season_episode_manager.html?seriesId=${seriesId}`;
                }, 1500);

            }).catch(error => {
                message.textContent = `ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ${episodeNumberInput} ØºÙŠØ± Ù…ÙƒØ±Ø±.`;
                message.style.color = 'var(--accent-color)';
                console.error("Error writing episode: ", error);
            });
        });

        // ğŸ”¥ Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
        auth.onAuthStateChanged(user => {
            if (!user || user.uid !== ADMIN_UID) {
                window.location.href = './login.html';
            }
        });
    </script>
</body>
</html>
